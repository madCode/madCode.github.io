</<!DOCTYPE html>
<html>
<head>
	<title></title>
</head>
<body>
<script>
  window.fbAsyncInit = function() {
    FB.init({
      appId      : '1077245369008098',
      xfbml      : true,
      version    : 'v2.6'
    })
    FB.getLoginStatus(function(response) {
	  if (response.status === 'connected') {
	    console.log('Logged in.');
	  }
	  else {
	    FB.login();
	  }
	});
  };

  (function(d, s, id){
     var js, fjs = d.getElementsByTagName(s)[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement(s); js.id = id;
     js.src = "//connect.facebook.net/en_US/sdk.js";
     fjs.parentNode.insertBefore(js, fjs);
   }(document, 'script', 'facebook-jssdk'));
</script>

<script>
var posts = {};

var getJSON = function(url, callback) {
    var xhr = new XMLHttpRequest();
    xhr.open("get", url, true);
    xhr.responseType = "json";
    xhr.onload = function() {
      var status = xhr.status;
      if (status == 200) {
        callback(null, xhr.response);
      } else {
        callback(status);
      }
    };
    xhr.send();
};

// Only works after `FB.init` is called
function myFacebookLogin() {
  FB.login(function(){
  // Note: The call will only work if you accept the permission request
  // FB.api('/me/feed', 'post', {message: 'Hello, world!'});
}, {scope: 'publish_actions,user_posts'});
}

function getFeed(after) {
/* make the API call */
var limit = document.getElementById("postInput").value;
FB.api(
    "/me/feed?limit=" + limit + "&after=" + after,
    function (response) {
      recordResponse(response, 1);
    }
);}

function recordResponse(response, pageNum) {
  if (response && response.error) {
    alert("Something went wrong: " + response.error);
    console.log(response.error);
  }
  if (response && !response.error) {
    for (var i = 0; i < response.data.length; i++){
      var objectId = response.data[i].id;
      posts[objectId] = {};
      posts[objectId].message = response.data[i].message;
      getLikes(objectId, "");
    }
    if (response.paging && response.paging.next) {
      if (pageNum % 20 == 0) {
        console.log("Finished page " + pageNum);        
      }
      getJSON(response.paging.next,
      function(err, data) {
        if (err != null) {
          alert("Something went wrong: " + err);
        } else {
          recordResponse(data, pageNum + 1);
        }
      }); 
    } else {
      alert("Finished! Found " + Object.keys(posts).length + 
        " posts!");
      analyzePosts();
    }
  }

}

function getLikes(objectId, after) {
  FB.api(
      "/" + objectId + "/reactions" + after,
      function (response) {
        if (response && !response.error) {
          /* handle the result */
          if (!posts[objectId].reactions){
            posts[objectId].reactions = [];
          }
          posts[objectId].reactions = posts[objectId].reactions.concat(response.data);
          if (response.paging && response.paging.next) {
            getLikes(objectId, "?after=" + response.paging.cursors.after);
          } else {
            //console.log(posts[objectId].message);
            //console.log(posts[objectId].reactions.length);
          }
        }
      }
  );
}

function averageReactions() {
  var keys = Object.keys(posts);
  var total = keys.length;
  var sum = 0;
  for (var i = 0; i < total; i++) {
    try {
      sum += posts[keys[i]].reactions.length;
    } catch (err) {
      console.log(err);
      console.log(i);
      debugger;
    }
    
  }
  return float(sum/total);
}

function analyzePosts() {
  var avg = document.getElementById("avg-title");
  var avgNum = avg.insertAdjacentHTML('afterend', averageReactions());
}

// graph: average number of likes, standard deviation


//store: how many likes, who liked it, type
//store: who are my friends and when did they become my friend?
//for each post: what are the tiers of popularity for a post, avg, standard deviation, are they split into time bands
//for a person: who likes most of my posts? Who has never liked anything?

</script>
<button onclick="myFacebookLogin()">Login with Facebook</button>
<input id="postInput" type="text" name="number">
<button onclick="getFeed()">get my feed</button>
<h1 id="avg-title">Average Number of Likes: </h1>
</body>
</html>>